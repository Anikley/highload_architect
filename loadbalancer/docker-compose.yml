version: '3.8'
services:
  mysql_master9:
    image: mysql:5.7
    env_file:
      - ./master/mysql_master.env
    container_name: "mysql_master9"
    restart: "no"
    ports:
      - 4406:3306
    volumes:
      - ./master/conf/mysql.conf.cnf:/etc/mysql/conf.d/mysql.conf.cnf
      - ./master/data:/var/lib/mysql
    networks:
      - overlay

  mysql_slave91:
    image: mysql:5.7
    env_file:
      - ./slave/mysql_slave.env
    container_name: "mysql_slave91"
    restart: "no"
    ports:
      - 5506:3306
    depends_on:
      - mysql_master9
    volumes:
      - ./slave/conf/mysql1.conf.cnf:/etc/mysql/conf.d/mysql.conf.cnf
      - ./slave/data1:/var/lib/mysql
    networks:
      - overlay

  mysql_slave92:
    image: mysql:5.7
    env_file:
      - ./slave/mysql_slave.env
    container_name: "mysql_slave92"
    restart: "no"
    ports:
      - 5507:3306
    depends_on:
      - mysql_master9
    volumes:
      - ./slave/conf/mysql2.conf.cnf:/etc/mysql/conf.d/mysql.conf.cnf
      - ./slave/data2:/var/lib/mysql
    networks:
      - overlay
      
  haproxy:
    image: "haproxy:2.2-alpine"
    ports:
      - 3306:3306
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg
    networks:
      - overlay
      
  prometheus:
    image: prom/prometheus
    container_name: prometheus
    ports:
      - 9090:9090
    expose: [ "9090" ]
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    command: 
      - --config.file=/etc/prometheus/prometheus.yml
    labels:
        org.label-schema.group: "monitoring"
    depends_on:
    - cadvisor
    networks:
      - overlay    
      
  grafana:
    image: grafana/grafana:7.3.6
    container_name: grafana
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_USER=${ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    restart: unless-stopped
    depends_on:
    - prometheus
    ports:
      - '3333:3000'
    labels:
      org.label-schema.group: "monitoring"
    networks:
      - overlay
      
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    ports:
    - 8080:8080
    networks:
      - overlay
    volumes:
    - /:/rootfs:ro
    - /var/run:/var/run:rw
    - /sys:/sys:ro
    - /var/lib/docker/:/var/lib/docker:ro         

volumes:
  grafana_data: {}
  
networks:
  overlay:

